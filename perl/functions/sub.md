# Что такое функция sub в perl и как ее использовать

Функция <font color="#00aa00">sub</font> используется для определения подпрограмм в коде perl-программы.


**Именованные объявления**

<pre>
sub NAME PROTO ATTRS
sub NAME ATTRS
sub NAME PROTO
sub NAME
</pre>

**Именованные определения**

<pre>
sub NAME PROTO ATTRS BLOCK
sub NAME ATTRS BLOCK
sub NAME PROTO BLOCK
sub NAME BLOCK
</pre>

**Неименованные определения**

<pre>
sub PROTO ATTRS BLOCK
sub ATTRS BLOCK
sub PROTO BLOCK
sub BLOCK
</pre>

Т.е. функция <font color="#00aa00">sub</font> принимает в качестве параметров значения <font color="#00aa00">NAME PROTO ATTRS BLOCK</font> - все они не являются обязательными. Главное условие: должен быть задан хотя бы один параметр - <font color="#00aa00">NAME</font> или <font color="#00aa00">BLOCK</font>.


### Параметр NAME - задает имя подпрограммы

Если указан только параметр <font color="#00aa00">NAME</font>, конструкция будет считаться предварительным объявлением имени подпрограммы, и в дальнейшем нужно будет определить саму подпрограмму.

Пример:

```perl
sub function1;
# ...

sub function1 {print "OK";}
```

Если <font color="#00aa00">NAME</font> задана вместе с <font color="#00aa00">BLOCK</font>, то  конструкция будет считаться стандартным именованным определением подпрограммы. В дальнейшем подпрограмму можно вызывать по имени.

Пример:

```perl
sub function1 {return "OK";}

$status = function1; # вызов подпрограммы
```


### Параметр BLOCK - задает код подпрограммы

Может указываться без <font color="#00aa00">NAME</font>. В этом случае функция <font color="#00aa00">sub</font> вернет ссылку на код. Ссылку можно использовать для вызова и выполнения заданной подпрограммы.

Подобная подпрограмма будет называться анонимной.

Пример:

```perl
my $param = "rose";

my $func_link = sub {
        my $param = shift;
        print $param;
        return "OK";
};

my $status = &amp;{$func_link}($param);
print $status;
```

### Параметр ATTRS - задает список атрибутов подпрограммы

<font color="#00aa00">ATTRS</font> используется сравнительно редко. В списке атрибутов разделителями служат символы двоеточия или пробела.

Существует 3 стандартных атрибута подпрограмм: <font color="#00aa00">locked, method, lvalue</font>. Атрибуты влияют на принципы использования подпрограммы.

<ul>
<li><b>Атрибут locked</b> - используется при работе с потоками. При установке данного атрибута использование функции ограничивается только одним потоком в определенный момент времени (а остальные в это время сидят, нервно курят и ожидают освобождения подпрограммы).
<pre>sub function1 : locked { return "OK"; }</pre>
</li>
<li><b>Атрибут method</b> - указывает, что подпрограмма является методом какого-то объекта.
В сочетании с атрибутом <font color="#00aa00">locked</font> организует не только блокировку подпрограммы и возможность ее использования только одним потоком, но и блокировку объекта, который вызывает этот метод.
Использование атрибута <font color="#00aa00">method</font> без <font color="#00aa00">locked</font> довольно бессмысленно.
<pre>sub function1 : locked method { return "OK"; }</pre>
</li>
<li><b>Атрибут lvalue</b> - позволяет присвоить подпрограмме значение. При этом, подпрограмма должна возвращать значение, которое допускает такое присваивание.

Пример:
<pre>
my $value;
sub function : lvalue {
        $value;
};
function() = 20;

print $value; # напечатает '20'
</pre>
В чем смысл практического применения такого атрибута - для меня пока загадка.</li>
</ul>

Perl предоставляет возможности для самостоятельного создания атрибутов. Но в данном документе эту проблему я рассматривать не буду.

### Параметр PROTO - задает список прототипов

Прототипы позволяют ввести проверку типа передаваемых подпрограмме данных. Проверка
осуществляется на стадии компиляции программы.

Пример:

С помощью прототипов указано, что подпрограмма может принимать 2 параметра - скаляр и хэш, в заданном порядке.

```perl
#!/usr/local/bin/perl

sub get ($\%) {
        my $name = shift;
        my $params = shift;

        print $name, "\n";
        print $params-&gt;{phone}, "\n";
}
my %params = (
        'phone' =&gt; '8768',
        'office' =&gt; '457',
);
get('Lesly', %params);
```

Если попробовать передать подпрограмме больше или меньше параметров, или вместо хеша - ссылку на хеш, то perl вернет ошибку:

<pre>
% perl test.pl
Type of arg 2 to main::get must be hash (not hash element) at scalar.pl line 19, 
near "})"
Execution of scalar.pl aborted due to compilation errors.
</pre>

При указании прототипов можно использовать следующие символы:
<ul>
<li><font color="#00aa00">$</font> - подпрограмме должен быть передан скаляр.</li>
<li><font color="#00aa00">&amp;</font> - подпрограмме должна быть передана в качестве параметра другая подпрограмма.</li>
<li><font color="#00aa00">*</font> - подпрограмме должен быть передан скаляр или ссылка на typeglob.</li>
<li><font color="#00aa00">\символ</font> - подпрограмме должна быть передана переменная типа "символ".</li>
<li><font color="#00aa00">;</font> - символ ";" отделяет обязательные параметры от необязательных.</li>
<li><font color="#00aa00">@</font> - объединяет все оставшиеся параметры и передает их подпрограмме как список.</li>
<li><font color="#00aa00">%</font> - объединяет все оставшиеся параметры и передает их подпрограмме как список.</li>
</ul>

Проверка прототипов не производится, если:
<ul>
<li>подпрограмма является методом объекта,</li>
<li>подпрограмма вызывается с указанием префикса "&amp;".</li>
</ul>
