# Как Apache обрабатывает поступивший запрос 2. Модель процессов prefork

Сервер <font color="#009900">Apache 1.X на Unix-платформах использует для работы модель процессов <b>prefork</b></font>.

<font color="#009900">При запуске сервера стартует один-единственный процесс (родительский).</font> Его главное назначение - создавать (с помощью <font color="#009900"><b>fork()</b></font> ) и завершать дочерние процессы по мере необходимости. Конфигурационные директивы Apache позволяют контролировать количество порождаемых процессов.

<font color="#009900">Обработкой клиентских запросов занимаются дочерние процессы</font>. Один дочерний процесс в один момент времени может обрабатывать только один запрос. Чтобы обслужить в один момент времени, например, 1000 клиентов, требуется 1000 одновременно работающих процессов.
Срок жизни порожденного процесса определяется директивой <font color="#009900"><b>MaxRequestsPerChild</b></font>. Директива определяет количество запросов, которое будет обработано процессом, после чего процесс заменяется новым.

После запуска сервера, <font color="#009900">родительский процесс создает пул дочерних процессов</font>, готовых обрабатывать входящие запросы клиентов.

Когда Apache получает запрос, <font color="#009900">родительский процесс ищет свободный дочерний процесс и поручает ему обработку запроса</font>. Если свободные процессы отсутствуют, родительский процесс проверяет - не исчерпан ли лимит на количество единовременно существующих процессов, и если возможно - создает новый процесс и поручает ему поступившую задачу. Если лимит исчерпан - поступивший запрос ставится в очередь на обработку.

Максимальная длина очереди ограничивается директивой <font color="#009900"><b>ListenBacklog</b></font>. Если очередь достигает максимальной длины, клиенту, приславшему новый запрос будет возвращаться ошибка с сообщением о недоступности сервера.

Для управления пулом дочерних процессов Apache предоставляет директивы:
<ol>
<li><font color="#009900"><b>StartServers</b></font> - директива определяет число порожденных процессов, создаваемых Apache при запуске сервера.</li>
<li><font color="#009900"><b>MinSpareServers</b></font> - директива устанавливает минимальное число процессов Apache, которые должны быть доступны в любой момент времени. Если все процессы заняты обработкой клиентских запросов, Apache запускает новые процессы, сохраняя пул доступных серверов на минимальном уровне.</li>
<li><font color="#009900"><b>MaxSpareServers</b></font> - директива устанавливает максимальное число процессов Apache, которые могут бездействовать в любой момент времени.</li>
<li><font color="#009900"><b>MaxClients</b></font> - определяет максимальное число дочерних процессов, которые будут созданы для обработки запросов.</li>
</ol>

## Достоинства и недостатки модели prefork

<font color="#009900">Модель <b>prefork</b> отличается высокой надежностью</font>. Программный код, обеспечивающий функционирование родительского процесса, очень прост и надежен, и вероятность возникновения ошибок на данном уровне крайне мала. Программный код дочерних процессов, наоборот, достаточно сложен. При подключении дополнительных модулей к серверу, запуске некорректных скриптов, существует вероятность возникновения ошибок и конфликтов, которые могут привести к неожиданному и преждевременному завершению дочернего процесса. Однако, исправно функционирующий родительский процесс сможет отследить ситуацию и своевременно создаст еще одного "ребенка". Кроме того, дочерние процессы изолированы друг от друга. Возникновение ошибки или аварийное завершение одного процесса никак не скажется на других процессах, и значит, обслуживание других клиентов не будет прервано.

Одним из основных недостатков модели <b>prefork</b> является ее <font color="#009900">требовательность к ресурсам памяти.</font>
