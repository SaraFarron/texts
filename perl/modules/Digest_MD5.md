# Работа с md5 в Perl. Digest::MD5

## Краткая справка о MD5

<font color="#00aa00">MD5 (Message Digest 5)</font> - 128-битный алгоритм хеширования текстов.

Алгоритму скармливается любой текст. Результатом работы алгоритма является последовательность из 32 шестнадцатеричных цифр, которую называют MD5-хешом.

Можно провести аналогию с "отпечатком пальца". Однако, в отличие от отпечатков пальца, где
каждый отпечаток уникален, алгоритм может производить одинаковые хеши для разных текстов. Это считается основным недостатком алгоритма.

MD5-хеш используется для определения подлинности опубликованных текстов:

<ul>
<li>публикуется текст и соответствующий ему MD5-хеш;</li>
<li>при желании, клиент может сам вычислить MD5-хеш для опубликованного текста и сравнить его с опубликованным там же MD5-хешом.</li>
</ul>

Малейшее изменение в исходном тексте приводит к тому, что MD5-хеш приобретает абсолютно другое значение.

Обратное преобразование MD5-хеша в текст не возможно.

С помощью MD5 можно проверять целостность скачиваемых файлов, проверять корректность
введенного пользователем пароля без необходимости хранить открытый пароль в БД, и т.д.

## Digest::MD5

Модуль <font color="#00aa00">Digest::MD5</font> позволяет использовать алгоритм хеширования текстов MD5 в Perl программах. Алгоритм пожирает текст произвольной длины и возвращает 128-битный "дайджест" (хеш) текста.

<font color="#00aa00">Digest::MD5</font> предлагает для использования как процедурный, так и объектно-ориентированный интерфейс.

### Функции Digest::MD5

<font color="#00aa00">Digest::MD5</font> позволяет использовать для работы с md5 функции
<font color="#00aa00">md5(), md5_hex(), md5_base64()</font>. По умолчанию, функции не экспортируются.

```perl
#!/usr/bin/perl -w

use strict;
use CGI;

use Digest::MD5 qw(md5 md5_hex md5_base64);

my $digest;
my $text = qq{Карл у Клары украл кораллы};

$digest = md5($text);
print $digest."\n";
$digest = md5_hex($text);
print $digest."\n";
$digest = md5_base64($text);
print $digest."\n";

exit;
```

Результат выполнения скрипта:
<pre>
%perl md5.pl
ЩRU%
    _пмШЫтr
10fd52db0855250cb4d0cd13fbf9d472
EP1S2whVJQy00M0T+/nUcg
</pre>

#### md5($data,...)

<pre>$digest = md5($text);</pre>

Функция объединяет в один текст все переданные аргументы, и вычисляет для полученного текста
MD5-дайджест. Результат возвращается в бинарном формате. Возвращенная последовательность будет иметь длину
12 байтов.

#### md5_hex($data,...)

```perl
my $text = qq{Карл у Клары украл кораллы};
$digest = md5_hex($text);
print $digest."\n";

# изменяем регистр у всего одной буквы - значение хеша полностью изменится
$text = qq{Карл у клары украл кораллы}; 
$digest = md5_hex($text);
print $digest."\n";
```

Результаты выполнения:
<pre>
%perl md5.pl
10fd52db0855250cb4d0cd13fbf9d472
19d0beb7f6b8d544eb59e1699c4cf9a5
</pre>

Функция возвращает дайджест в шестнадцатеричном формате. Длина последовательности составит 32 символа и будет включать в себя только цифры и латинские буквы от "a" до "f".


#### md5_base64($data,...)

<pre>$digest = md5_base64($text);</pre>

Возвращает "дайджест" для указанных аргументов в виде base64 - последовательности печатных ASCII символов. Длина возвращенной последовательности будет составлять 22 символа и может содержать цифры, буквы латинского алфавита в верхнем и нижнем регистре, символы "+" и "/".

### Методы Digest::MD5

<font color="#00aa00">Digest::MD5</font> предоставляет возможность работы через объектный интерфейс. Он очень простой и симпатичный.

```perl
#!/usr/bin/perl -w

use strict;
use CGI;

use Digest::MD5;

my $text = qq{Карл у Клары украл кораллы};
my $md5 = Digest::MD5->new;
$md5->add($text);

print $md5->clone->digest."\n";
print $md5->clone->hexdigest."\n";
print $md5->clone->b64digest."\n";
$md5->reset;

exit;
```

Результат выполнения скрипта:
<pre>
%perl md5.pl
ЩRU%
    _пмШЫтr
10fd52db0855250cb4d0cd13fbf9d472
EP1S2whVJQy00M0T+/nUcg
%
</pre>

#### $md5 = Digest::MD5-&gt;new

Метод <font color="#00aa00">new()</font> возвращает новый объект <font color="#00aa00">Digest::MD5</font>. Можно вызвать по отношению к уже существующему объекту - <font color="#00aa00">$md5-&gt;new</font> . В этом случае, будет произведена "перезагрудка"
указанного объекта, и он станет доступен для повторного использования.

#### $md5-&gt;add($data,...)

Метод <font color="#00aa00">add()</font> определяет данные, для которых в дальнейшем можно проводить вычисления. Можно задать несколько аргументов - они будут объеденены в один общий текст, для которого потом будет вычислен хеш.

Значение, которое возвращает метод - это сам объект $md5.

#### $md5-&gt;addfile($io_handle)

```perl
#!/usr/bin/perl -w

use strict;
use CGI;

use Digest::MD5;

my $md5 = Digest::MD5->new;

open FILE, "file.pl" || die "Can't open file";
$md5->addfile(*FILE);
close FILE;

print $md5->clone->digest."\n";
print $md5->clone->hexdigest."\n";
print $md5->clone->b64digest."\n";

exit;
```

Результаты работы:
<pre>
%perl md5.pl
b}Ъ_M _Ў|тш№Ю
621c7d95ff9c4d2098a17cd4dbb915e0
Yhx9lf+cTSCYoXzU27kV4A
</pre>
Метод <font color="#00aa00">addfile()</font> назначает файл, для которого в дальнейшем будут проводиться вычисления. Значение, которое возвращает метод - сам объект <font color="#00aa00">$md5</font>.

Если, по каким-то причинам, метод не сможет прочитать указанный файл - он сообщит об этом.
После такой ошибки лучше перезагрузить объект и только после этого продолжить работу.

#### $md5-&gt;digest

<pre>$md5->digest;</pre>

Вычисляет и возвращает бинарный "дайджест" для указанного текста. Полученная строка будет иметь длину 16 байтов.

Возможен интересный сюрприз для тех, кто использует <font color="#00aa00">Digest::MD5</font> впервые и невнимательно читает документацию. После выполнения, <font color="#00aa00">digest()</font> разрушает объект, для которого он был вызван.

Это означает, что если вы забудете об этом, и после вызова <font color="#00aa00">digest()</font> решите получить еще и значение <font color="#00aa00">hexdigest()</font>, то вы его получите. Но это значение будет высчитано для пустой строки, а не для заданного Вами ранее текста.

Если объект Вам нужен и после <font color="#00aa00">digest()</font>, рекомендуется вызывать метод через <font color="#00aa00">clone()</font>:

<pre>$md5->clone->digest;</pre>

#### $md5-&gt;hexdigest

Возвращает шестнадцатеричный MD5-хеш для указанного текста (файла). Полученная строка будет иметь длину в 32 символа, и состоять только из цифр и букв латинского алфавита от "a" до "f".. После выполнения, <font color="#00aa00">hexdigest()</font> разрушает объект, для которого он был вызвана.

#### $md5-&gt;b64digest

Возвращает "дайджест" для указанного текста (файла) в виде base64 - последовательности
печатных ASCII символов. Длина возвращенной строки будет составлять 22 символа и может содержать цифры, буквы латинского алфавита в верхнем и нижнем регистре, символы "+" и "/".

#### $md5-&gt;clone

Метод создает копию объекта $md5. Методы <font color="#00aa00">digest(), hexdigest(), b64digest()</font> после использования "перезагружают" объект. Во избежание этого можно сначала создавать копию объекта $md5, а потом применять к ней методы <font color="#00aa00">digest(), hexdigest(), b64digest()</font> . Таким образом, исходный объект - <font color="#00aa00">$md5</font> - остается в целости и сохранности, и доступен для дальнейшего использования.

#### $md5-&gt;reset

Алиас <font color="#00aa00">$md5-&gt;new</font> . Удобно использовать для "сброса" всех настроек объекта $md5 и его дальнейшего повторного использования.


### Примеры работы с Digest::MD5

#### Генерация хеша

```perl
#!/usr/bin/perl -w

use strict;
use Digest::MD5 qw(md5_hex);

print "Введите пароль:\n";
my $pass = <stdin>;
chomp($pass); # обрезаем \n
print md5_hex($pass)."\n";

exit;
```

Результат работы скрипта:
<pre>
%perl create_md5.pl
Введите пароль:
asSa
bb456cfc65785beda9ec0c034e2a54ae
</pre>

#### Сравнение паролей по хешу

Cкрипт принимает пароль, преобразует в хеш MD5 и проверяет его соответствие имеющемуся хешу MD5.

```perl
#!/usr/bin/perl -w

use strict;
use Digest::MD5 qw(md5_hex);

my $correct_pass = "bb456cfc65785beda9ec0c034e2a54ae";
print "Введите пароль:\n";
my $pass = <stdin>;
chomp($pass); # обрезаем \n

if ($correct_pass eq md5_hex($pass)) {
	print "Добро пожаловать!\n";
} else {
	print "Пошел нафиг!\n";
}
exit;
```

Результат работы скрипта:
<pre>
%perl create_md5.pl
Введите пароль:
asSa
Добро пожаловать!
</pre>

